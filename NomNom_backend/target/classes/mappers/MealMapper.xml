<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ssafy.nomnom.model.dao.MealDao">

	<!-- 식단 조회(사용자별/일자) -->
	<select id="selectMealByUserAndRegDate" parameterType="MealRequest" resultType="MealResponse">
		SELECT
		m.meal_no as mealNo, meal_title as mealTitle, meal_time as mealTime,
		ROUND(SUM(nutri_energy), 1) AS energy,
		ROUND(SUM(nutri_carbohydrate), 1) AS carbohydrate,
		ROUND(SUM(nutri_protein), 1) AS protein,
		ROUND(SUM(nutri_total_fatty_acids), 1) AS totalFattyAcids
		FROM meal m
		JOIN meal_food mf ON m.meal_no = mf.meal_no
		JOIN food f ON mf.food_code = f.food_code
		WHERE meal_reg_date = #{mealRegDate}
		AND user_no = #{userNo}
		AND meal_time != 'WATER'
		GROUP BY m.meal_no
		ORDER BY FIELD(meal_time, 'BREAKFAST', 'LUNCH', 'DINNER', 'SNACK')
	</select>


	<!-- 식단 및 식단에 포함된 영양소 총합 조회(단일) -->
	<select id="selectMealAndNutriSumByMealNo" parameterType="int" resultType="MealResponse">
		SELECT 
			m.meal_no AS mealNo, 
			meal_reg_date AS mealRegDate, 
			meal_time AS mealTime, 
			meal_title AS mealTitle, 
			meal_content AS mealContent,
		
			ROUND(SUM(f.nutri_energy), 1) AS energy,
			ROUND(SUM(f.nutri_carbohydrate), 1) AS carbohydrate,
			ROUND(SUM(f.nutri_sugar), 1) AS sugar,
			ROUND(SUM(f.nutri_dietary_fiber), 1) AS dietaryFiber,
			ROUND(SUM(f.nutri_protein), 1) AS protein,
			ROUND(SUM(f.nutri_ash), 1) AS ash,
			ROUND(SUM(f.nutri_total_fatty_acids), 1) AS totalFattyAcids,
			ROUND(SUM(f.nutri_saturated_fats), 1) AS saturatedFats,
			ROUND(SUM(f.nutri_monounsaturated_fats + f.nutri_polyunsaturated_fats), 1) AS unsaturatedFats,
			ROUND(SUM(f.nutri_water), 1) AS water,
			ROUND(SUM(f.nutri_vitamin_a_carotene), 1) AS vitaminACarotene,
			ROUND(SUM(f.nutri_vitamin_b1), 1) AS vitaminB1,
			ROUND(SUM(f.nutri_vitamin_b2), 1) AS vitaminB2,
			ROUND(SUM(f.nutri_niacin), 1) AS niacin,
			ROUND(SUM(f.nutri_folate), 1) AS folate,
			ROUND(SUM(f.nutri_vitamin_c), 1) AS vitaminC,
			ROUND(SUM(f.nutri_vitamin_d), 1) AS vitaminD,
			ROUND(SUM(f.nutri_cholesterol), 1) AS cholesterol,
			ROUND(SUM(f.nutri_sodium), 1) AS sodium,
			ROUND(SUM(f.nutri_calcium), 1) AS calcium,
			ROUND(SUM(f.nutri_iron), 1) AS iron,
			ROUND(SUM(f.nutri_phosphorus), 1) AS phosphorus,
			ROUND(SUM(f.nutri_potassium), 1) AS potassium
		
		FROM meal m
		JOIN meal_food mf ON m.meal_no = mf.meal_no
		JOIN food f ON mf.food_code = f.food_code
		WHERE m.meal_no = #{mealNo}
		GROUP BY mealNo, mealRegDate, mealTime, mealTitle, meal_content

	</select>


	<!-- 식단에 포함된 음식들 조회 -->
	<select id="selectFoodsByMealNo" parameterType="int" resultType="Food">
		SELECT 
			f.food_code AS foodCode, 
			food_amount AS foodAmount,
			food_name AS foodName,
			food_sub_group AS foodSubGroup,
			ROUND(food_weight * food_amount, 1) AS foodWeight,
			ROUND(nutri_energy * food_amount, 1) AS nutriEnergy,
			ROUND(nutri_carbohydrate * food_amount, 1) AS nutriCarbohydrate,
			ROUND(nutri_protein * food_amount, 1) AS nutriProtein,
			ROUND(nutri_total_fatty_acids * food_amount, 1) AS nutriTotalFattyAcids
		
		FROM meal m
		JOIN meal_food mf ON m.meal_no = mf.meal_no
		JOIN food f ON mf.food_code = f.food_code
		WHERE m.meal_no = #{mealNo}
	</select>


	<!-- 식단 등록 -->
	<insert id="insertMeal" parameterType="MealRequest" useGeneratedKeys="true" keyProperty="mealNo">
		INSERT INTO meal
		(user_no,
		meal_reg_date, meal_time,
		meal_title, meal_content)
		VALUES (#{userNo},
		#{mealRegDate},
		#{mealTime}, #{mealTitle}, #{mealContent})
	</insert>


	<!-- 식단_음식 등록 -->
	<insert id="insertMealFood" parameterType="MealFood">
		INSERT INTO meal_food
		(meal_no, food_code, food_amount) 
        VALUES (
		#{mealNo}, #{foodCode}, #{foodAmount})
	</insert>

	
	<!-- 음식 이름으로 음식 검색 -->
	<select id="selectFoodByFoodName" parameterType="String" resultType="SimpleFoodResponse">
		SELECT 
		food_code AS foodCode,
		food_name AS foodName,
		food_sub_group AS foodSubGroup
		FROM food
		WHERE food_name LIKE CONCAT('%', #{foodName}, '%')
	</select>
	
	<!-- 음식 조회 (음식 코드) -->
	<select id="selectFoodByFoodCode" parameterType="String" resultType="Food">
		SELECT 
			food_code AS foodCode,
			food_name AS foodName,
			food_sub_group AS foodSubGroup,
			ROUND(food_weight, 1) AS foodWeight,
			ROUND(nutri_energy, 1) AS nutriEnergy,
			ROUND(nutri_carbohydrate, 1) AS nutriCarbohydrate,
			ROUND(nutri_protein, 1) AS nutriProtein,
			ROUND(nutri_total_fatty_acids, 1) AS nutriTotalFattyAcids
		FROM food
		WHERE food_code = #{foodCode};
	</select>
	
	
	<!-- 식단 수정(제목, 메모, 식사시간) -->
	<update id="updateMeal" parameterType="MealRequest">
		UPDATE meal 
		SET
		meal_reg_date = '2025-06-21',
		meal_time = '',
		meal_title = '',
		meal_content = ''
		WHERE meal_no = #{mealNo};
	</update>

	<!-- 식단 삭제 -->
	<delete id="deleteMeal" parameterType="int">
		DELETE FROM meal
		WHERE
		meal_no = #{mealNo}
	</delete>

	<!-- 식단_음식 삭제(식단별) -->
	<delete id="deleteMealFoodByMealNo" parameterType="int">
		DELETE FROM
		meal_food
		WHERE meal_no = #{mealNo}
	</delete>

	<!-- 식단_음식 삭제(단일) -->
	<delete id="deleteMealFoodByMealFoodNo" parameterType="int">
		DELETE
		FROM meal_food
		WHERE meal_food_no =
		#{mealFoodNo}
	</delete>
	
	
	<!-- 물 섭취 목록 조회(enum='WATER')(사용자별/일자) -->
	<select id="selectWaterListByUserAndRegDate" parameterType="MealRequest" resultType="MealResponse">
		SELECT 
		m.meal_no as mealNo,
		meal_title as mealTitle,
		(food_amount * food_weight) as foodAmount
		FROM meal m
		JOIN meal_food mf ON m.meal_no = mf.meal_no
		JOIN food f ON mf.food_code = f.food_code
		WHERE meal_time = 'WATER'
		AND user_no = #{userNo}
		AND meal_reg_date = #{mealRegDate}
	</select>
	
	<!-- 날짜별 모든 영양성분 총합 조회(영양분석) : reportDayResponse 객체-->
	<select id="selectDayNutriSum" parameterType="MealRequest" resultType="reportDayResponse">
		SELECT
			meal_reg_date AS reportDate,
			ROUND(SUM(f.nutri_energy), 1) AS energy,
			ROUND(SUM(f.nutri_carbohydrate), 1) AS carbohydrate,
			ROUND(SUM(f.nutri_sugar), 1) AS sugar,
			ROUND(SUM(f.nutri_dietary_fiber), 1) AS dietaryFiber,
			ROUND(SUM(f.nutri_protein), 1) AS protein,
			ROUND(SUM(f.nutri_ash), 1) AS ash,
			ROUND(SUM(f.nutri_total_fatty_acids), 1) AS totalFattyAcids,
			ROUND(SUM(f.nutri_saturated_fats), 1) AS saturatedFats,
			ROUND(SUM(f.nutri_monounsaturated_fats + f.nutri_polyunsaturated_fats), 1) AS unsaturatedFats,
			ROUND(SUM(f.nutri_water), 1) AS water,
			ROUND(SUM(f.nutri_vitamin_a_carotene), 1) AS vitaminACarotene,
			ROUND(SUM(f.nutri_vitamin_b1), 1) AS vitaminB1,
			ROUND(SUM(f.nutri_vitamin_b2), 1) AS vitaminB2,
			ROUND(SUM(f.nutri_niacin), 1) AS niacin,
			ROUND(SUM(f.nutri_folate), 1) AS folate,
			ROUND(SUM(f.nutri_vitamin_c), 1) AS vitaminC,
			ROUND(SUM(f.nutri_vitamin_d), 1) AS vitaminD,
			ROUND(SUM(f.nutri_cholesterol), 1) AS cholesterol,
			ROUND(SUM(f.nutri_sodium), 1) AS sodium,
			ROUND(SUM(f.nutri_calcium), 1) AS calcium,
			ROUND(SUM(f.nutri_iron), 1) AS iron,
			ROUND(SUM(f.nutri_phosphorus), 1) AS phosphorus,
			ROUND(SUM(f.nutri_potassium), 1) AS potassium
		FROM meal m
		JOIN meal_food mf ON m.meal_no = mf.meal_no
		JOIN food f ON mf.food_code = f.food_code
		WHERE user_no = #{userNo}
		AND meal_reg_date = #{mealRegDate}
		GROUP BY meal_reg_date
	</select>
	
	
	<!-- 오늘 기준 일주일간 주요 영양성분 일별 총합 조회(최근 7일 주요 영양소 기록) : reportDayResponse List-->
	<select id="selectWeeklyDayNutriSum" parameterType="int" resultType="reportDayResponse">
		WITH RECURSIVE date_seq AS (
		    SELECT CURDATE() AS reportDate
		    UNION ALL
		    SELECT DATE_SUB(reportDate, INTERVAL 1 DAY)
		    FROM date_seq
		    WHERE reportDate > DATE_SUB(CURDATE(), INTERVAL 6 DAY)
		)
		SELECT 
		    ds.reportDate,
		    ROUND(SUM(f.nutri_energy), 1) AS energy,
		    ROUND(SUM(f.nutri_carbohydrate), 1) AS carbohydrate,
		    ROUND(SUM(f.nutri_protein), 1) AS protein,
		    ROUND(SUM(f.nutri_total_fatty_acids), 1) AS totalFattyAcids,
		    ROUND(SUM(f.nutri_water), 1) AS water
		FROM date_seq ds
		LEFT JOIN meal m ON DATE(m.meal_reg_date) = ds.reportDate AND m.user_no = #{userNo}
		LEFT JOIN meal_food mf ON m.meal_no = mf.meal_no
		LEFT JOIN food f ON mf.food_code = f.food_code
		GROUP BY ds.reportDate
		ORDER BY ds.reportDate
	</select>
	
	
	<!-- 오늘 기준 일주일간 영양성분별 일평균 조회(주간 영양소 평균) : reportDayResponse -->
	<select id="selectWeeklyNutriAvg" parameterType="int" resultType="reportDayResponse">
		SELECT
			ROUND(AVG(energy), 1) AS energy,
			ROUND(AVG(carbohydrate), 1) AS carbohydrate,
			ROUND(AVG(protein), 1) AS protein,
			ROUND(AVG(totalFattyAcids), 1) AS totalFattyAcids,
			ROUND(AVG(water), 1) AS water
		FROM (
			SELECT
				SUM(f.nutri_energy) AS energy,
				SUM(f.nutri_carbohydrate) AS carbohydrate,
				SUM(f.nutri_protein) AS protein,
				SUM(f.nutri_total_fatty_acids) AS totalFattyAcids,
				SUM(f.nutri_water) AS water
			FROM meal m
			JOIN meal_food mf ON m.meal_no = mf.meal_no
			JOIN food f ON mf.food_code = f.food_code
			WHERE m.user_no = #{userNo}
			  AND m.meal_reg_date BETWEEN DATE_SUB(CURDATE(), INTERVAL 6 DAY) AND CURDATE()
			GROUP BY DATE(m.meal_reg_date)
		) AS daily_totals;
	</select>
	
	<!-- 오늘 기준 일주일간 끼니(아침, 점심, 저녁)별 칼로리 평균(끼니별 칼로리 분석) : reportWeeklyResponse 객체 -->
	<select id="selectWeeklyMealTimeNutriAvg" parameterType="int" resultType="reportWeeklyResponse">
		SELECT
		    ROUND(AVG(CASE WHEN m.meal_time = 'BREAKFAST' THEN f.nutri_energy ELSE NULL END), 2) AS avgBreakfastEnergy,
		    ROUND(AVG(CASE WHEN m.meal_time = 'LUNCH' THEN f.nutri_energy ELSE NULL END), 2) AS avgLunchEnergy,
		    ROUND(AVG(CASE WHEN m.meal_time = 'DINNER' THEN f.nutri_energy ELSE NULL END), 2) AS avgDinnerEnergy
		FROM meal m
		JOIN meal_food mf ON m.meal_no = mf.meal_no
		JOIN food f ON mf.food_code = f.food_code
		WHERE m.user_no = #{userNo}
		AND m.meal_reg_date BETWEEN DATE_SUB(CURDATE(), INTERVAL 6 DAY) AND CURDATE()
	</select>
	
	
	<!-- 오늘 기준 월간 요일별 영양성분 평균 조회(요일별 영양소 섭취 평균) : reportDayResponse List-->
	<select id="selectMonthlyWeekdayNutriAvg" parameterType="int" resultType="ReportDayResponse">
		WITH weekdays AS (
		  SELECT 'Monday' AS weekday UNION ALL
		  SELECT 'Tuesday' UNION ALL
		  SELECT 'Wednesday' UNION ALL
		  SELECT 'Thursday' UNION ALL
		  SELECT 'Friday' UNION ALL
		  SELECT 'Saturday' UNION ALL
		  SELECT 'Sunday'
		),
		daily_totals AS (
		  SELECT
		    DAYNAME(m.meal_reg_date) AS weekday,
		    SUM(f.nutri_energy) AS energy,
		    SUM(f.nutri_carbohydrate) AS carbohydrate,
		    SUM(f.nutri_protein) AS protein,
		    SUM(f.nutri_total_fatty_acids) AS totalFattyAcids,
		    SUM(f.nutri_water) AS water
		  FROM meal m
		  JOIN meal_food mf ON m.meal_no = mf.meal_no
		  JOIN food f ON mf.food_code = f.food_code
		  WHERE m.user_no = #{userNo}
		    AND m.meal_reg_date BETWEEN DATE_SUB(CURDATE(), INTERVAL 29 DAY) AND CURDATE()
		  GROUP BY DATE(m.meal_reg_date), DAYNAME(m.meal_reg_date)
		)
		
		SELECT
		  w.weekday AS reportWeekday,
		  ROUND(AVG(dt.energy), 1) AS energy,
		  ROUND(AVG(dt.carbohydrate), 1) AS carbohydrate,
		  ROUND(AVG(dt.protein), 1) AS protein,
		  ROUND(AVG(dt.totalFattyAcids), 1) AS totalFattyAcids,
		  ROUND(AVG(dt.water), 1) AS water
		FROM weekdays w
		LEFT JOIN daily_totals dt ON w.weekday = dt.weekday
		GROUP BY w.weekday
		ORDER BY FIELD(w.weekday, 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday');
		</select>


	<!-- 오늘 기준 월간 끼니(아침, 점심, 저녁)별 횟수 조회(끼니별 식사 횟수) : reportMonthlyResponse 객체 -->
	<select id="selectMonthlyWeekdayCnt" parameterType="int" resultType="reportMonthlyResponse">
		SELECT
		    COUNT(CASE WHEN m.meal_time = 'BREAKFAST' THEN 1 END) AS breakfastCount,
		    COUNT(CASE WHEN m.meal_time = 'LUNCH' THEN 1 END) AS lunchCount,
		    COUNT(CASE WHEN m.meal_time = 'DINNER' THEN 1 END) AS dinnerCount
		FROM meal m
		JOIN meal_food mf ON m.meal_no = mf.meal_no
		JOIN food f ON mf.food_code = f.food_code
		WHERE m.user_no = #{userNo}
		AND m.meal_reg_date BETWEEN DATE_SUB(CURDATE(), INTERVAL 30 DAY) AND CURDATE()
	</select>

	<!-- 오늘 기준 월간 일 별 주요 영양성분별 평균 조회 : reportMonthlyResponse 객체 -->
	<select id="selectMonthlyDayNutriAvg" parameterType="int" resultType="reportMonthlyResponse">
		SELECT
		    ROUND(AVG(carbohydrate), 1) AS avgMonthlycarbohydrate,
			ROUND(AVG(protein), 1) AS avgWeeklyProtein,
			ROUND(AVG(totalFattyAcids), 1) AS avgWeeklyTotalFattyAcids,
			ROUND(AVG(sodium), 1) AS avgMonthlySodium,
			ROUND(AVG(sugar), 1) AS avgMonthlySugar
		FROM (
		    SELECT
		        SUM(f.nutri_carbohydrate) AS carbohydrate,
		        SUM(f.nutri_protein) AS protein,
		        SUM(f.nutri_total_fatty_acids) AS totalFattyAcids,
		        SUM(f.nutri_sugar) AS sugar,
		        SUM(f.nutri_sodium) AS sodium
		    FROM meal m
		    JOIN meal_food mf ON m.meal_no = mf.meal_no
		    JOIN food f ON mf.food_code = f.food_code
		    WHERE m.user_no = #{userNo}
		      AND m.meal_reg_date BETWEEN DATE_SUB(CURDATE(), INTERVAL 30 DAY) AND CURDATE()
		    GROUP BY DATE(m.meal_reg_date)
		) AS daily_totals
	</select>

</mapper>